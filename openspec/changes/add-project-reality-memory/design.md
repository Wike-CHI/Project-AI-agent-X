## Context

构建一个统一的系统来记录项目实际运行状态和管理AI Companion的记忆。需要支持：

1. **AI行为记录**：记录AI的决策、执行过程和结果
2. **项目状态跟踪**：记录项目整体状态和变化
3. **记忆管理**：短期记忆（会话内）和长期记忆（持久化）

### 约束条件
- 需与现有 `GraphMemory` 和向量存储集成
- 需支持多用户隔离
- 需考虑性能（大量记录写入）
- 需支持记忆检索和总结

## Goals / Non-Goals

### Goals
- 提供统一的记录API
- 支持短期/长期记忆自动管理
- 支持语义检索和关系追踪
- 提供记忆总结和过期机制

### Non-Goals
- 不替换现有的 `GraphMemory`，而是与其集成
- 不实现复杂的权限系统（依赖现有auth）
- 不实现实时推送（可后续扩展）

## Decisions

### 1. 记录存储架构
- **行为记录**：使用SQLite表存储（`reality_records`）
- **项目状态**：使用SQLite表存储（`project_states`）
- **记忆存储**：
  - 短期记忆：内存缓存 + SQLite持久化
  - 长期记忆：向量存储（Qdrant）+ SQLite索引

**决策理由**：平衡性能和可靠性，简单记录用SQLite，向量数据用Qdrant。

### 2. 记忆生命周期
- **短期记忆**：会话结束时自动转换为长期记忆（摘要形式）
- **长期记忆**：按重要性评分过期清理
- **默认过期**：30天无访问的长记忆进入归档

### 3. API 设计原则
- RESTful风格
- 统一的响应格式
- 支持批量操作

## Risks / Trade-offs

| 风险 | 缓解措施 |
|------|----------|
| 大量写入影响性能 | 使用异步写入、批量提交 |
| 记忆检索不准确 | 调整向量相似度阈值、提供过滤 |
| 存储空间增长 | 自动清理过期记忆 |

## Migration Plan

1. 创建新表，不影响现有数据
2. 新API独立路径，不影响现有API
3. 渐进式集成：先实现基础功能，再集成到Agent

## Open Questions

- [x] 是否需要支持记忆加密？→ 当前不需要，用户认证已足够
- [x] 是否需要支持多租户？→ 当前单用户版本，暂无需求
